import{c as ne,R as B,d as le,b as oe,r as l,s as u,j as e,L as x,H as S,X as ce}from"./index-CuLUR7ue.js";import{N as F,S as z}from"./Navbar-DUxwz1eI.js";import{P as de,T as H,C as O}from"./confirmation-dialog-BDzsuAYg.js";import{M as me}from"./map-pin-C7Y8q8FH.js";import"./user-CLQm5Qt5.js";import"./hoist-non-react-statics.cjs-BgISz65J.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=ne("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]),X=a=>new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(a),xe=()=>{const{user:a,loading:D}=le(),{toast:c}=oe(),[h,b]=l.useState([]),[_,p]=l.useState(0),[J,C]=l.useState(!0),[j,I]=l.useState(!1),[K,k]=l.useState(!1),[m,y]=l.useState(null),[v,q]=l.useState([]),[V,E]=l.useState(!0),[T,L]=l.useState(!1),[P,R]=l.useState(!1),[N,w]=l.useState(null),[W,A]=l.useState(!1),[d,f]=l.useState({governorate:"",city:"",street:"",notes:"",is_default:!1}),M=l.useCallback(async()=>{if(!a){C(!1);return}C(!0);try{const{data:t,error:s}=await u.from("cart_items").select(`
          id,
          quantity,
          products:product_id (
            id,
            name_ar,
            description_ar,
            price,
            image_url
          )
        `).eq("user_id",a.id);if(s)throw s;if(!t){b([]);return}const n=t.map(r=>{const o=Array.isArray(r.products)?r.products[0]:r.products;return{cartItemId:r.id,productId:(o==null?void 0:o.id)||0,name_ar:(o==null?void 0:o.name_ar)||"منتج غير متوفر",description_ar:(o==null?void 0:o.description_ar)||null,price:(o==null?void 0:o.price)||0,image_url:(o==null?void 0:o.image_url)||null,quantity:r.quantity}});b(n);const i=n.reduce((r,o)=>r+o.price*o.quantity,0);p(i)}catch(t){console.error("Failed to fetch cart items:",t),c({title:"خطأ في تحميل سلة التسوق",description:"تعذر تحميل محتويات سلة التسوق",variant:"destructive"})}finally{C(!1)}},[a,c]);l.useEffect(()=>{a&&M()},[a,M]);const U=l.useCallback(async()=>{if(a){E(!0);try{const{data:t,error:s}=await u.from("user_addresses").select("*").eq("user_id",a.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(s)throw s;const n=(t||[]).filter(r=>r&&r.id&&r.user_id&&r.governorate&&r.city&&r.street).map(r=>({id:r.id,user_id:r.user_id,governorate:r.governorate,city:r.city,street:r.street,notes:r.notes||null,is_default:r.is_default||!1,created_at:r.created_at,updated_at:r.updated_at}));q(n);const i=n.find(r=>r.is_default)||n[0];y(i||null)}catch(t){console.error("Failed to fetch addresses:",t),c({title:"خطأ في تحميل العناوين",description:"تعذر تحميل عناوين الشحن الخاصة بك",variant:"destructive"})}finally{E(!1)}}},[a,c]);l.useEffect(()=>{a&&U()},[a,U]);const Y=l.useCallback(async(t,s)=>{if(!(!a||s<1))try{const{error:n}=await u.from("cart_items").update({quantity:s}).eq("id",t);if(n)throw n;b(i=>i.map(r=>r.cartItemId===t?{...r,quantity:s}:r)),p(i=>{const r=h.find(o=>o.cartItemId===t);return r?i-r.price*r.quantity+r.price*s:i})}catch(n){console.error("Failed to update quantity:",n),c({title:"خطأ في التحديث",description:"حدث خطأ أثناء تحديث الكمية",variant:"destructive"})}},[a,h,c]),Z=l.useCallback(async t=>{if(a)try{const{error:s}=await u.from("cart_items").delete().eq("id",t);if(s)throw s;b(n=>{const i=n.find(r=>r.cartItemId===t);return i&&p(r=>r-i.price*i.quantity),n.filter(r=>r.cartItemId!==t)}),c({title:"تم الحذف",description:"تمت إزالة المنتج من السلة"})}catch(s){console.error("Failed to remove item:",s),c({title:"خطأ في الحذف",description:"حدث خطأ أثناء إزالة المنتج من السلة",variant:"destructive"})}},[a,c]),Q=l.useCallback(async()=>{if(a)try{const{error:t}=await u.from("cart_items").delete().eq("user_id",a.id);if(t)throw t;b([]),p(0),c({title:"تم إفراغ السلة",description:"تمت إزالة جميع العناصر من سلة التسوق"})}catch(t){console.error("Failed to clear cart:",t),c({title:"خطأ في إفراغ السلة",description:"حدث خطأ أثناء محاولة إفراغ السلة",variant:"destructive"})}},[a,c]),ee=l.useCallback(async()=>{if(a){L(!0);try{if(!d.governorate||!d.city||!d.street)throw new Error("الرجاء ملء جميع الحقول المطلوبة");const{data:t,error:s}=await u.from("user_addresses").insert({governorate:d.governorate,city:d.city,street:d.street,notes:d.notes||null,is_default:d.is_default||!1,user_id:a.id}).select().single();if(s)throw s;if(!t||!t.id||!t.user_id||!t.governorate||!t.city||!t.street)throw new Error("استجابة غير صالحة من الخادم");const n={id:t.id,user_id:t.user_id,governorate:t.governorate,city:t.city,street:t.street,notes:t.notes||null,is_default:t.is_default||!1,created_at:t.created_at,updated_at:t.updated_at};q(i=>[...i,n]),y(n),A(!1),f({governorate:"",city:"",street:"",notes:"",is_default:!1}),c({title:"تمت إضافة العنوان",description:"تم إضافة عنوان الشحن الجديد بنجاح"})}catch(t){const s=t;console.error("Failed to add address:",s),c({title:"خطأ في إضافة العنوان",description:s.message||"حدث خطأ أثناء إضافة العنوان",variant:"destructive"})}finally{L(!1)}}},[a,d,c]),te=l.useCallback(async t=>{if(a){R(!0),w(t);try{const{error:s}=await u.from("user_addresses").delete().eq("id",t);if(s)throw s;if(q(n=>n.filter(i=>i.id!==t)),(m==null?void 0:m.id)===t){const n=v.find(i=>i.id!==t)||null;y(n)}c({title:"تم حذف العنوان",description:"تم حذف عنوان الشحن بنجاح"})}catch(s){console.error("Failed to delete address:",s),c({title:"خطأ في حذف العنوان",description:"حدث خطأ أثناء حذف العنوان",variant:"destructive"})}finally{R(!1),w(null)}}},[a,m,v,c]),re=l.useCallback(async()=>{if(!(h.length===0||!a)){if(!m){c({title:"عنوان الشحن مطلوب",description:"يرجى اختيار أو إضافة عنوان شحن لإتمام الطلب",variant:"destructive"});return}I(!0);try{const{data:t,error:s}=await u.from("orders").insert({user_id:a.id,total_amount:_,status:"pending",payment_status:"pending",shipping_address:{governorate:m.governorate,city:m.city,street:m.street,notes:m.notes}}).select().single();if(s)throw s;if(!t||!t.id)throw new Error("فشل في إنشاء الطلب");const n=h.map(r=>({order_id:t.id,product_id:r.productId,quantity:r.quantity,unit_price:r.price,total_price:r.price*r.quantity})),{error:i}=await u.from("order_items").insert(n);if(i)throw i;await u.from("cart_items").delete().eq("user_id",a.id),b([]),p(0),c({title:"تم تأكيد الطلب",description:"سيتم التواصل معك قريباً لتأكيد التفاصيل"}),window.location.href=`/orders/${t.id}`}catch(t){const s=t;console.error("Checkout error:",s),c({title:"خطأ في تأكيد الطلب",description:s.message||"حدث خطأ غير متوقع",variant:"destructive"})}finally{I(!1)}}},[h,a,_,m,c]),se=B.memo(({item:t,updateQuantity:s,removeFromCart:n})=>{const[i,r]=l.useState(!1),[o,$]=l.useState(!1),G=async g=>{r(!0);try{await s(t.cartItemId,g)}catch(ie){console.error("Failed to update quantity:",ie)}finally{r(!1)}},ae=async()=>{$(!0);try{await n(t.cartItemId)}catch(g){console.error("Failed to remove item:",g)}finally{$(!1)}};return e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4 sm:p-6 flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-4 space-x-reverse w-full sm:w-auto",children:[e.jsx("img",{src:t.image_url||"/placeholder-image.png",alt:t.name_ar||"",className:"w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg",loading:"lazy",onError:g=>g.currentTarget.src="/placeholder-image.png"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-lg font-bold text-amber-900 truncate",children:t.name_ar}),t.description_ar&&e.jsx("p",{className:"text-amber-700 text-sm line-clamp-2",children:t.description_ar}),e.jsx("p",{className:"text-amber-900 font-bold mt-1",children:X(t.price||0)})]})]}),e.jsxs("div",{className:"flex items-center justify-between w-full sm:w-auto",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse bg-amber-50 rounded-lg px-2",children:[e.jsx("button",{onClick:()=>G(Math.max(1,t.quantity-1)),className:"p-1 sm:p-2 hover:bg-amber-100 rounded-lg disabled:opacity-50",disabled:t.quantity<=1||i,"aria-label":"تقليل الكمية",children:i?e.jsx(x,{className:"animate-spin",size:16}):e.jsx(ue,{size:16})}),e.jsx("span",{className:"px-2 sm:px-3 py-1 min-w-[30px] text-center",children:t.quantity}),e.jsx("button",{onClick:()=>G(t.quantity+1),className:"p-1 sm:p-2 hover:bg-amber-100 rounded-lg disabled:opacity-50",disabled:i,"aria-label":"زيادة الكمية",children:i?e.jsx(x,{className:"animate-spin",size:16}):e.jsx(de,{size:16})})]}),e.jsx("button",{onClick:ae,className:"p-2 text-red-600 hover:bg-red-50 rounded-lg ml-4 disabled:opacity-50",disabled:o,"aria-label":"إزالة من السلة",children:o?e.jsx(x,{className:"animate-spin",size:20}):e.jsx(H,{size:20})})]})]})});return D||J?e.jsxs("div",{dir:"rtl",className:"min-h-screen bg-gradient-to-b from-amber-50 to-orange-50",children:[e.jsxs(S,{children:[e.jsx("title",{children:"جاري التحميل - سلة التسوق"}),e.jsx("meta",{name:"description",content:"جاري تحميل محتويات سلة التسوق الخاصة بك"})]}),e.jsx(F,{}),e.jsxs("div",{className:"container mx-auto px-6 py-20 text-center",children:[e.jsx(x,{className:"mx-auto mb-4 text-amber-700 animate-spin",size:48}),e.jsx("p",{className:"text-xl text-amber-700",children:"جاري تحميل سلة المشتريات..."})]})]}):a?e.jsxs("div",{dir:"rtl",className:"min-h-screen bg-gradient-to-b from-amber-50 to-orange-50",children:[e.jsxs(S,{children:[e.jsx("title",{children:"سلة التسوق - قهوة دمنهور"}),e.jsx("meta",{name:"description",content:"إدارة مشترياتك وتأكيد طلباتك من متجر قهوة دمنهور"})]}),e.jsx(F,{}),e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(z,{className:"mx-auto mb-4 text-amber-700",size:48}),e.jsx("h1",{className:"text-3xl font-bold text-amber-900",children:"سلة التسوق"})]}),h.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx(z,{className:"mx-auto mb-4 text-gray-400",size:64}),e.jsx("p",{className:"text-xl text-gray-600 mb-4",children:"سلة التسوق فارغة"}),e.jsx("a",{href:"/",className:"bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 transition-colors","aria-label":"تصفح المنتجات",children:"تصفح المنتجات"})]}):e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs("button",{onClick:()=>k(!0),className:"text-red-600 hover:text-red-800 flex items-center","aria-label":"إفراغ السلة",children:[e.jsx(H,{size:20,className:"mr-1"}),"إفراغ السلة"]})}),e.jsx("div",{className:"space-y-4 mb-8",children:h.map(t=>e.jsx(se,{item:t,updateQuantity:Y,removeFromCart:Z},t.cartItemId))}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-amber-900 mb-4 flex items-center",children:[e.jsx(me,{className:"mr-2",size:24}),"عنوان الشحن"]}),V?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(x,{className:"mx-auto animate-spin text-amber-700",size:32}),e.jsx("p",{className:"mt-2",children:"جاري تحميل العناوين..."})]}):e.jsxs(e.Fragment,{children:[v.length>0?e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:v.map(t=>e.jsxs("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors relative
                              ${(m==null?void 0:m.id)===t.id?"border-amber-600 bg-amber-50":"border-gray-200 hover:border-amber-400"}`,onClick:()=>y(t),children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),w(t.id)},className:"absolute top-2 left-2 p-1 text-red-500 hover:text-red-700","aria-label":"حذف العنوان",disabled:P&&N===t.id,children:P&&N===t.id?e.jsx(x,{className:"animate-spin",size:20}):e.jsx(ce,{size:20})}),e.jsxs("div",{className:"font-medium",children:[t.governorate," - ",t.city]}),e.jsx("div",{className:"text-gray-600 mt-1",children:t.street}),t.notes&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:["ملاحظات: ",t.notes]}),t.is_default&&e.jsx("span",{className:"inline-block mt-2 px-2 py-1 bg-amber-100 text-amber-800 text-xs rounded",children:"العنوان الافتراضي"})]},t.id))})}):e.jsx("p",{className:"text-gray-500 mb-4",children:"لا توجد عناوين مسجلة"}),e.jsx("button",{onClick:()=>A(!0),className:"text-amber-700 hover:text-amber-900 font-medium mb-6",children:"+ إضافة عنوان جديد"}),W&&e.jsxs("div",{className:"bg-amber-50 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-bold text-amber-900 mb-3",children:"إضافة عنوان جديد"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium text-gray-700",children:"المحافظة"}),e.jsx("input",{type:"text",value:d.governorate||"",onChange:t=>f({...d,governorate:t.target.value}),placeholder:"أدخل المحافظة",className:"w-full p-2 border border-amber-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium text-gray-700",children:"المدينة"}),e.jsx("input",{type:"text",value:d.city||"",onChange:t=>f({...d,city:t.target.value}),placeholder:"أدخل المدينة",className:"w-full p-2 border border-amber-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium text-gray-700",children:"العنوان التفصيلي"}),e.jsx("input",{type:"text",value:d.street||"",onChange:t=>f({...d,street:t.target.value}),placeholder:"أدخل العنوان التفصيلي",className:"w-full p-2 border border-amber-300 rounded-lg",required:!0})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block mb-1 text-sm font-medium text-gray-700",children:"ملاحظات (اختياري)"}),e.jsx("textarea",{value:d.notes||"",onChange:t=>f({...d,notes:t.target.value}),placeholder:"ملاحظات إضافية للعنوان",className:"w-full p-2 border border-amber-300 rounded-lg",rows:2})]}),e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{type:"checkbox",id:"defaultAddress",checked:d.is_default||!1,onChange:t=>f({...d,is_default:t.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"defaultAddress",className:"text-sm text-gray-700",children:"تعيين كعنوان افتراضي"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>{A(!1),f({governorate:"",city:"",street:"",notes:"",is_default:!1})},className:"px-4 py-2 text-gray-600 hover:text-gray-800",children:"إلغاء"}),e.jsx("button",{onClick:ee,disabled:T,className:"bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 disabled:opacity-50",children:T?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"animate-spin inline mr-2",size:16}),"جاري الإضافة..."]}):"حفظ العنوان"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("span",{className:"text-xl font-bold text-amber-900",children:"المجموع الكلي:"}),e.jsx("span",{className:"text-2xl font-bold text-amber-900",children:X(_)})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("button",{onClick:re,disabled:j||!m,className:`flex-1 py-3 rounded-lg font-bold transition-colors flex items-center justify-center ${j||!m?"bg-gray-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"}`,"aria-label":"تأكيد الطلب",children:[j&&e.jsx(x,{className:"animate-spin mr-2",size:20}),j?"جاري معالجة الطلب...":"تأكيد الطلب"]}),e.jsx("a",{href:"/",className:"flex-1 bg-amber-600 text-white py-3 rounded-lg hover:bg-amber-700 transition-colors font-bold text-center","aria-label":"متابعة التسوق",children:"متابعة التسوق"})]})]})]})]}),e.jsx(O,{open:K,onCancel:()=>k(!1),onConfirm:async()=>{try{await Q(),k(!1)}catch(t){console.error("Failed to clear cart:",t)}},title:"إفراغ سلة التسوق",message:"هل أنت متأكد من رغبتك في إفراغ سلة التسوق بالكامل؟",confirmText:"نعم، إفراغ السلة",cancelText:"إلغاء"}),e.jsx(O,{open:!!N,onCancel:()=>w(null),onConfirm:()=>te(N),title:"حذف عنوان الشحن",message:"هل أنت متأكد من رغبتك في حذف هذا العنوان؟",confirmText:"نعم، احذف",cancelText:"إلغاء"})]}):e.jsxs("div",{dir:"rtl",className:"min-h-screen bg-gradient-to-b from-amber-50 to-orange-50",children:[e.jsxs(S,{children:[e.jsx("title",{children:"تسجيل الدخول مطلوب - سلة التسوق"}),e.jsx("meta",{name:"description",content:"سجل الدخول لإدارة سلة التسوق الخاصة بك"})]}),e.jsx(F,{}),e.jsxs("div",{className:"container mx-auto px-6 py-20 text-center",children:[e.jsx(z,{className:"mx-auto mb-4 text-amber-700",size:64}),e.jsx("h2",{className:"text-2xl font-bold text-amber-900 mb-4",children:"يجب تسجيل الدخول أولاً"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"سجل الدخول لإدارة سلة المشتريات الخاصة بك"}),e.jsx("a",{href:"/auth",className:"bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 transition-colors","aria-label":"تسجيل الدخول",children:"تسجيل الدخول"})]})]})},ye=B.memo(xe);export{ye as default};
